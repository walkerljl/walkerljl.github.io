---
layout : post
title : Elasticsearch分布式
date : 2016-08-01
author : walkerljl
categories : blog
tag : Elasticsearch
---

# 一.概要
节点是Elasticsearch运行中的实例，而集群则包含一个或多个具有相同cluster.name的节点，它们协同工作，共享数据，并共同分担工作负荷。由于节点从属于集群，集群会自我重组来均地分发数据。

集群中的一个节点会被选为master节点，它将负责管理集群范畴的变更，例如创建或者删除索引，添加节点到集群或者从集群删除节点。master节点无需参与与文档层面的变更和搜索，因此虽然只有一个master节点，但是并不会因为流量的增长而成为瓶颈。任意一个节点都可以成为master节点。

作为用户，我们可以访问包括master节点在内的集群中的任一节点。每个节点都知道各个文档的位置，并能够将我们的请求直接转发到拥有我们想要的数据节点。无论我们访问的是哪个节点，它都会控制从拥有数据的节点收集响应的过程，并返回给客户端最终的结果。这一切都是由Elasticsearch透明管理的。

# 二.集群健康
在 Elasticsearch 集群中可以监控统计很多信息，其中最重要的就是：集群健康(cluster health)。它的 status 有 green、yellow、red 三种。

```
$ curl -XGET 'http://localhost:9200/_cluster/health?pretty'
```
status 可以告诉我们当前集群是否处于一个可用的状态。三种颜色分别代表：

|状态|意义|
|-----|:----:|
|green|所有主分片和从分片都可用|
|yellow|所有主分片可用，但存在不可用的从分片|
|red|存在不可用的主要分片|

# 三.添加索引
为了将数据添加到Elasticsearch，我们需要索引--存储关联数据的地方。实际上，索引只是一个逻辑命名空间，它指向一个或多个分片。

分片是工作单元底层的一员，它只是负责保存索引中所有数据的一小片。分片是一个独立的Lucene实例，并且它自身也是一个完整的搜索引擎。我们的文档存储并且被索引在分片中，但是我们的程序并不会在直接与它们通信，而是直接与索引通信。

在Elasticsearch中，分片是用来分配集群中的数据。把分片想象成一个数据的容器。数据被存储在分片中，然后分片又被分配在集群的节点上。当你的集群扩展或者缩小时，elasticsearch会自动的在节点之间迁移分配分片，以便集群保持均衡。

分片分为主分片（primary shard）以及从分片（replica shard）两种。在索引中，每一个文档都属于一个主分片，所以具体多少主分片取决于你的索引能存储多少数据。
>虽然理论上主分片对存储多少数据是没有限制的。分片的最大数量取决于你的实际状况：硬件的配置、文档的大小和复杂、如何索引和查询你的文档，以及你期望的响应时间。

从分片只是主分片的一个副本，它用于提供数据的冗余副本，在硬件故障时提供数据保护，同时服务于搜索和检索这两种制度请求。

索引中的主分片的数量在索引创建后就固定下来了，但是从分片的数量可以随时改变。

# 四.故障转移
使用同样的方式启动一个节点，新添加的cluster.name保持和现有节点的cluster.name一致，启动之后，新的节点能自动发现并加入到已有节点的集群中。
# 五.横向扩展
添加集群节点完成集群的横向扩展。新的节点加入后，分片会被重新分配以平衡负载。
# 六.扩展更多
主分片的数量在索引创建的时候就已经指定了，实际上，这个数字定义了能存储到索引中的数据最大量（具体的数量取决于你的数据、硬件的使用情况）。例如，读请求--搜索或者文档恢复就可以由主分片或者从分片来执行，所以当你拥有更多份数据的时候，你就拥有了更大的吞吐量。

从分片的数量可以在运行的集群中动态的调整，这样我们可以根据实际需求扩展或者缩小规模。

```
$ curl -XPUT 'http://localhost:9200/identity/_settings' -d '{
	"number_of_replicas" : 2
}'
```
>仅仅在同样数量的节点上增加从分片的数量不太能提高性能，因为每个分片都有访问系统资源的权限。你需要升级硬件配置以提高吞吐量。不过更多的分片意味着我们有更多的冗余。

# 七.故障恢复
只要有一个分片（不管是从分片还是主分片），该分片上的数据就不会丢失，节点down掉的时候会自动的failover。
# 参考资料
1. <https://es.xiaoleilu.com>
2. <http://www.learnes.net>
